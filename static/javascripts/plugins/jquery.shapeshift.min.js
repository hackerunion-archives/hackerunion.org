(function(a,b){function g(b,c){var d=this;d.container=a(b),d.options=a.extend({},f,c),d.init()}var d="shapeshift",f=(b.document,{centerGrid:!0,enableAnimation:!0,enableAnimationOnInit:!1,enableAutoHeight:!0,enableDrag:!0,enableDragAnimation:!0,enableRearrange:!0,enableResize:!0,enableTrash:!1,animateSpeed:160,columns:null,dragClone:!1,dragRate:75,dragWhitelist:"*",dropCutoff:0,dropWhitelist:"*",gutterX:10,gutterY:10,minHeight:200,paddingY:0,paddingX:0,selector:""});g.prototype.init=function(){var a=this;a.initialized=!1,a.eventSetup(),a.container.trigger("ss-event-arrange")},g.prototype.eventSetup=function(){var a=this,b=a.options;a.container.attr("data-ss-rearrangeable",b.enableRearrange),a.container.off("ss-event-arrange").on("ss-event-arrange",function(){a.arrange()}),a.container.off("ss-event-dragreset").on("ss-event-dragreset",function(){a.dragClear(),a.drag()}),jQuery.ui?jQuery.ui.draggable?b.enableDrag?a.container.trigger("ss-event-dragreset"):a.dragClear():b.enableDrag&&alert("jQuery.shapeshift is trying to enable drag and drop but jQuery UI Draggable/Droppable has not been included yet."):b.enableDrag&&alert("jQuery.shapeshift is trying to enable drag and drop but jQuery UI has not been included yet."),b.enableResize&&a.resize()},g.prototype.arrange=function(){var b=this,c=b.options,d=b.container.children(c.selector).filter(":visible"),e=b.getPositions(b.container,!1),f=b.initialized,g=!0;g=d.filter(".ss-moving")[0]?c.enableDragAnimation:c.enableAnimation,f||(g=c.enableAnimationOnInit);for(var h=0;e.length>h;h++){var i=a(d[h]);i.hasClass("ss-moving")||(g?i.stop(!0,!1).animate(e[h],c.animateSpeed):i.css(e[h]))}b.container.css("height",c.containerHeight),f||(b.initialized=!0)},g.prototype.drag=function(){function k(b){f=a(b.target),g=f.outerHeight()/2,h=f.outerWidth()/2,$curContainer=f.parent(),d.dragClone&&($clone=f.clone().insertBefore(f).addClass("ss-clone")),f.addClass("ss-moving"),$curContainer.trigger("ss-event-dragged",f)}function l(b){$clone=a(".ss-clone"),$clone[0]&&($cloneContainer=$clone.parent(),$cloneContainer[0]===f.parent()[0]?$clone.remove():($clone.removeClass("ss-clone"),$cloneContainer.trigger("ss-event-dragreset"),f.parent().trigger("ss-event-dragreset"))),a(b.target).removeClass("ss-moving").parent().trigger("ss-event-arrange")}function m(k,l){!j&&$curContainer.data("ss-rearrangeable")&&(j=!0,i=c.getIntendedPosition(k),e=$curContainer.children(":not(.ss-moving):visible"),i!=e.size()?$curContainer[0]!=f.parent()[0]?($target=e.last(),$target[0]?f.insertAfter($target):$curContainer.prepend(f)):($target=e.get(i),f.insertBefore($target)):($target=e.get(i-1),f.insertAfter($target)),$target||f.appendTo($curContainer),$curContainer.trigger("ss-event-arrange"),a(".ss-prev-container").trigger("ss-event-arrange"),b.setTimeout(function(){j=!1},d.dragRate)),l.position.left=k.pageX-f.parent().offset().left-h,l.position.top=k.pageY-f.parent().offset().top-g}function n(){d.enableTrash?(f=a(".ss-moving").remove(),a(".ss-prev-container").trigger("ss-event-arrange").trigger("ss-event-destroyed",f)):(f=a(".ss-moving").removeClass("ss-moving"),$selectedContainer=f.parent(),$selectedContainer.trigger("ss-event-arrange").trigger("ss-event-dropped",f))}function o(b){$curContainer.addClass("ss-prev-container"),$curContainer=a(b.target).removeClass("ss-prev-container")}var c=this,d=c.options;$curContainer=c.container;var f,g,h,i,e=c.container.children(d.selector),j=!1;e.filter(d.dragWhitelist).draggable({addClasses:!1,containment:"document",zIndex:9999,drag:function(a,b){m(a,b)},start:function(a,b){k(a,b)},stop:function(a){l(a)}}),c.container.droppable({accept:d.dropWhitelist,tolerance:"intersect",drop:function(a){n(a)},over:function(a){o(a)}})},g.prototype.dragClear=function(){this.container.droppable().droppable("destroy"),this.container.children().draggable().draggable("destroy")},g.prototype.getPositions=function(c,d){var e=this,f=e.options,g=c.children(f.selector).filter(":visible"),h=f.columns,i=[],j=null,k=f.paddingX,l=[];d&&(g=g.not(".ss-moving")),f.childWidth=g.first().outerWidth(!0),j=f.childWidth+f.gutterX,h||(h=Math.floor(c.innerWidth()/j),h>g.length&&(h=g.length)),f.centerGrid&&(k=Math.floor((c.innerWidth()-h*j)/2)+f.gutterX/2);for(var m=0;h>m;m++)i.push(f.paddingY);for(var n=0;g.length>n;n++){var o=a(g[n]),p=a.inArray(Math.min.apply(b,i),i),q=o.outerHeight(!0)+f.gutterY,r=j*p+k,s=i[p];attributes={left:r,top:s},l[n]=attributes,i[p]+=q}return f.enableAutoHeight&&(q=Math.max.apply(Math,i),f.minHeight>q&&(q=f.minHeight),f.containerHeight=q),l},g.prototype.getIntendedPosition=function(){for(var c=this,d=c.options,e=a(".ss-moving"),f=e.parent(),g=0,h=e.position().left+d.childWidth/2,i=e.position().top+e.outerHeight()/2,j=9999,k=c.getPositions(f,!0),l=k.length-d.dropCutoff,m=0;k.length>m;m++)if(l>m&&(attributes=k[m],h>attributes.left&&i>attributes.top)){var n=h-attributes.left,o=i-attributes.top;if(distance=Math.sqrt(n*n+o*o),j>distance&&(j=distance,g=m,m===k.length-1)){var p=f.children().not(".ss-moving").last();(o>.75*p.outerHeight()||n>.75*d.childWidth||0>n)&&g++}}return g},g.prototype.resize=function(){var c=this,d=!1;a(b).on("resize",function(){d||(d=!0,setTimeout(function(){d=!1,c.container.trigger("ss-event-arrange")},75))})},a.fn[d]=function(b){return this.each(function(){a.data(this,"plugin_"+d,new g(this,b))})}})(jQuery,window);